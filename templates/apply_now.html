<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1, shrink-to-fit=no" name="viewport" />
    <title>Nasheman - Apply Now</title>
    <!-- External Libraries -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/css/bootstrap.min.css" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/slick-carousel/1.8.1/slick-theme.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/slick-carousel/1.8.1/slick.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com" rel="preconnect">
    <link href="https://fonts.gstatic.com" crossorigin rel="preconnect">
    <link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@300;400;600;700;800&family=Poppins:wght@500;600;700;800;900&family=Raleway:wght@100;500;600;700;800;900&display=swap" rel="stylesheet">
    <!-- Custom CSS -->
    <link href="{{ url_for('static', filename='css/style.css') }}" rel="stylesheet">
    <style>
        
        .motivational-quote { color: #fff; font-family: 'Raleway', sans-serif; font-weight: 500; text-shadow: 1px 1px 3px rgba(0,0,0,0.5); }
        .form-container { max-width: 800px; margin: 50px auto; padding: 20px; background: #f9f9f9; border-radius: 10px; box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
        .progress { height: 10px; margin-bottom: 20px; background: #e9ecef; border-radius: 5px; overflow: hidden; }
        .progress-bar { height: 100%; background: #007bff; transition: width 0.3s ease; }
        .step { display: none; }
        .step.active { display: block; }
        .form-group label { font-weight: bold; font-family: 'Open Sans', sans-serif; }
        .form-control { margin-bottom: 15px; }
        .form-control-file { margin-bottom: 15px; }
        
        .error { color: red; font-size: 0.9em; display: none; }
        .error.show { display: block; }
        #submitApplication { display: none; }
        #submitApplication.show { display: block !important; visibility: visible !important; opacity: 1 !important; }
        #submitApplication:disabled { opacity: 0.65; cursor: not-allowed; }
        .photo-preview { margin-top: 10px; max-width: 120px; max-height: 150px; display: none; border: 1px solid #ddd; border-radius: 5px; }
        .review-container { max-width: 900px; margin: 0 auto; padding: 30px; border: 2px solid #007bff; border-radius: 10px; background: #ffffff; }
        .review-header { text-align: center; margin-bottom: 30px; border-bottom: 2px solid #007bff; padding-bottom: 15px; }
        .review-header h1 { font-family: 'Poppins', sans-serif; font-weight: 700; font-size: 1.8rem; color: #007bff; margin: 0; }
        .review-header h2 { font-family: 'Poppins', sans-serif; font-weight: 600; font-size: 1.4rem; color: #2c3e50; margin: 10px 0; }
        .review-photo { width: 120px; height: 150px; border: 2px dashed #6c757d; margin: 20px auto; display: flex; align-items: center; justify-content: center; font-size: 0.9rem; color: #6c757d; text-align: center; background: #f8f9fa; overflow: visible; }
        .review-photo img { width: 100%; height: 100%; object-fit: cover; display: block; }
        .review-photo.no-photo::after { content: 'No Photo'; display: block; }
        .review-section { margin-bottom: 20px; }
        .review-section h5 { font-family: 'Poppins', sans-serif; font-weight: 600; font-size: 1.2rem; color: #007bff; border-left: 4px solid #007bff; padding-left: 10px; margin-bottom: 15px; }
        .review-table { width: 100%; border-collapse: collapse; }
        .review-table th, .review-table td { border: 1px solid #d1d8dd; padding: 10px; text-align: left; vertical-align: top; }
        .review-table th { background: #f1f5f9; font-family: 'Poppins', sans-serif; font-weight: 600; color: #34495e; width: 30%; text-transform: uppercase; font-size: 0.9rem; }
        .review-table td { font-family: 'Open Sans', sans-serif; color: #2c3e50; font-size: 0.95rem; }
        .step-icons {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: 20px auto 30px;
            max-width: 600px;
            position: relative;
            padding: 0 20px;
        }
        .step-icons::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 0;
            right: 0;
            height: 2px;
            background: #b3e5fc;
            z-index: 0;
        }
        .step-icon {
            position: relative;
            text-align: center;
            color: #6c757d;
            z-index: 1;
            font-family: 'Poppins', sans-serif;
            font-weight: 500;
        }
        .step-icon i {
            font-size: 24px;
            margin-bottom: 5px;
            background: #fff;
            border: 2px solid #b3e5fc;
            border-radius: 50%;
            padding: 8px;
            transition: all 0.3s ease;
        }
        .step-icon span {
            display: block;
            font-size: 0.9rem;
            margin-top: 5px;
        }
        .step-icon.active {
            color: #007bff;
        }
        .step-icon.active i {
            background: #007bff;
            color: #fff;
            border-color: #007bff;
        }
        .step-icon[data-step="1"] i { background: #fce4ec; color: #f06292; }
        .step-icon[data-step="2"] i { background: #e8f5e9; color: #66bb6a; }
        .step-icon[data-step="3"] i { background: #fff3e0; color: #ffca28; }
        .step-icon[data-step="4"] i { background: #ede7f6; color: #ab47bc; }
        .step-icon[data-step="5"] i { background: #e0f7fa; color: #26c6da; }
        .step-icon[data-step="6"] i { background: #fffde7; color: #ffeb3b; }
        .affidavit-section { margin-top: 20px; padding: 15px; border: 1px solid #ddd; border-radius: 5px; background: #f8f9fa; }
        
        
    </style>
</head>
<body>
    <!-- Navbar  -->
    <nav class="navbar navbar-expand-lg fixed-top" id="navigation">
    <div class="container-fluid align-items-stretch">
        <div class="logo">
            <a class="navbar-brand" href="{{ url_for('index') }}">Nasheman</a>
        </div>
        <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNav">
            <ul class="navbar-nav ml-auto">
                <li class="nav-item "><a class="nav-link" href="{{ url_for('index') }}">Home</a></li>
                <li class="nav-item active"><a class="nav-link" href="{{ url_for('about') }}">About</a></li>
                <li class="nav-item "><a class="nav-link" href="{{ url_for('courses') }}">Courses</a></li>
                <li class="nav-item"><a class="nav-link" href="{{ url_for('events') }}">Events</a></li>
                <li class="nav-item"><a class="nav-link" href="{{ url_for('team') }}">Staff</a></li>
                <li class="nav-item"><a class="nav-link" href="{{ url_for('facilities') }}">Facilities</a></li>
                <li class="nav-item"><a class="nav-link" href="{{ url_for('admissions') }}">Admissions</a></li>
                <li class="nav-item"><a class="nav-link" href="{{ url_for('contact') }}">Contact</a></li>
                {% if session.get('user_type') == 'guardian' %}
    <li class="nav-item"><a class="nav-link" href="{{ url_for('guardian_settings') }}">Settings</a></li>
    <li class="nav-item"><a class="nav-link" href="{{ url_for('logout') }}">Logout</a></li>
{% elif session.get('user_type') == 'admin' %}
    <li class="nav-item"><a class="nav-link" href="{{ url_for('admin_dashboard') }}">Admin Dashboard</a></li>
    <li class="nav-item"><a class="nav-link" href="{{ url_for('logout') }}">Logout</a></li>
{% else %}
    <li class="nav-item"><a class="nav-link" href="{{ url_for('guardian_signup_page') }}">Sign Up</a></li>
    <li class="nav-item"><a class="nav-link" href="{{ url_for('guardian_login_page') }}">Login</a></li>
{% endif %}
            </ul>
        </div>
    </div>
</nav>

    <!-- Hero Banner -->
    <section class="dashboard">
        <div class="container">
            <div class="dashboard-banner animate__animated animate__fadeIn">
                <div class="section_title text-center">
                    <h2>Apply Now</h2>
                    <div class="motivational-quote" id="quote"></div>
                </div>
            </div>
        </div>
    </section>

    <!-- Step Icons -->
    <div class="step-icons">
        <div class="step-icon active" data-step="1"><i class="fa fa-user"></i><span>Personal Info</span></div>
        <div class="step-icon" data-step="2"><i class="fa fa-users"></i><span>Guardian Info</span></div>
        <div class="step-icon" data-step="3"><i class="fa fa-medkit"></i><span>Medical History</span></div>
        <div class="step-icon" data-step="4"><i class="fa fa-graduation-cap"></i><span>Education & Preferences</span></div>
        <div class="step-icon" data-step="5" style="display: none;"><i class="fa fa-file"></i><span>Affidavit</span></div>
        <div class="step-icon" data-step="6"><i class="fa fa-check-circle"></i><span>Summary/Review</span></div>
    </div>

    <!-- Admission Form -->
    <div class="container">
        <div class="form-container">
            <!-- Flash Messages -->
            {% with messages = get_flashed_messages(with_categories=true) %}
                {% if messages %}
                    {% for category, message in messages %}
                        <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
                            {{ message }}
                            <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                                <span aria-hidden="true">×</span>
                            </button>
                        </div>
                    {% endfor %}
                {% endif %}
            {% endwith %}
            <form id="applicationForm" method="POST" action="{{ url_for('submit_admission') }}" enctype="multipart/form-data">
                <!-- Progress Bar -->
                <div class="progress">
                    <div class="progress-bar" id="progressBar" style="width: 0%;"></div>
                </div>

                <!-- Step 1: Personal Info -->
                <div class="step active" data-step="1">
                    <h4>Step 1: Personal Information</h4>
                    <div class="form-group">
                        <label for="studentName">Student Name *</label>
                        <input type="text" class="form-control" id="studentName" name="studentName" required>
                        <div class="error" id="studentNameError"></div>
                    </div>
                    <div class="form-group">
                        <label for="cnic">Student CNIC *</label>
                        <input type="text" class="form-control" id="cnic" name="cnic" required placeholder="12345-1234567-1" maxlength="15" pattern="\d{5}-\d{7}-\d{1}" title="Format: 12345-1234567-1" oninput="formatCNIC(this)">
                        <div class="error" id="cnicError"></div>
                    </div>
                    <div class="form-group">
                        <label for="dob">Date of Birth *</label>
                        <input type="date" class="form-control" id="dob" name="dob" required max="{{ today }}" min="1900-01-01" oninput="calculateAge()">
                        <div class="error" id="dobError"></div>
                    </div>
                    <div class="form-group">
                        <label for="gender">Gender *</label>
                        <select class="form-control" id="gender" name="gender" required>
                            <option value="">Select Gender</option>
                            <option value="M">Male</option>
                            <option value="F">Female</option>
                        </select>
                        <div class="error" id="genderError"></div>
                    </div>
                    <div class="form-group">
                        <label for="age">Age *</label>
                        <input type="number" class="form-control" id="age" name="age" required min="1" max="120" step="1">
                        <div class="error" id="ageError"></div>
                    </div>
                    <div class="form-group">
                        <label for="phone">Student Phone # *</label>
                        <input type="text" class="form-control" id="phone" name="phone" required placeholder="+923123456789" maxlength="13" pattern="\+92[0-9]{10}" title="Format: +923123456789">
                        <div class="error" id="phoneError"></div>
                    </div>
                    <div class="form-group">
                        <label for="address">Address *</label>
                        <textarea class="form-control" id="address" name="address" rows="3" required></textarea>
                        <div class="error" id="addressError"></div>
                    </div>
                    <div class="form-group">
                        <label for="studentOccupation">Student Occupation</label>
                        <input type="text" class="form-control" id="studentOccupation" name="studentOccupation">
                        <div class="error" id="studentOccupationError"></div>
                    </div>
                    <div class="form-group">
                        <label for="photo">Student Photo (Passport Size, PNG/JPG/JPEG, Max 5MB) *</label>
                        <input type="file" class="form-control-file" id="photo" name="photo" accept=".png,.jpg,.jpeg" required>
                        <img id="photoPreview" class="photo-preview" src="" alt="Photo Preview">
                        <div class="error" id="photoError"></div>
                    </div>
                    <div class="nav-btns">
                        <button type="button" class="btn btn-primary next-step">Next</button>
                    </div>
                </div>

                <!-- Step 2: Guardian Info -->
                <div class="step" data-step="2">
                    <h4>Step 2: Guardian Information</h4>
                    <div class="form-group">
                        <label for="parentName">Father/Mother Name *</label>
                        <input type="text" class="form-control" id="parentName" name="parentName" required>
                        <div class="error" id="parentNameError"></div>
                    </div>
                    <div class="form-group">
                        <label for="parentCnic">CNIC Number *</label>
                        <input type="text" class="form-control" id="parentCnic" name="parentCnic" required placeholder="12345-1234567-1" maxlength="15" pattern="\d{5}-\d{7}-\d{1}" title="Format: 12345-1234567-1" oninput="formatCNIC(this)">
                        <div class="error" id="parentCnicError"></div>
                    </div>
                    <div class="form-group">
                        <label for="parentPhone">Contact Number *</label>
                        <input type="text" class="form-control" id="parentPhone" name="parentPhone" required placeholder="+923123456789" maxlength="13" pattern="\+92[0-9]{10}" title="Format: +923123456789">
                        <div class="error" id="parentPhoneError"></div>
                    </div>
                    <div class="form-group">
                        <label for="parentOccupation">Occupation *</label>
                        <input type="text" class="form-control" id="parentOccupation" name="parentOccupation" required>
                        <div class="error" id="parentOccupationError"></div>
                    </div>
                    <div class="form-group">
                        <label for="numSiblings">Number of Siblings *</label>
                        <input type="number" class="form-control" id="numSiblings" name="numSiblings" required min="0" step="1">
                        <div class="error" id="numSiblingsError"></div>
                    </div>
                    <div class="form-group">
                        <label for="siblingDisability">Any Disability in Siblings</label>
                        <input type="text" class="form-control" id="siblingDisability" name="siblingDisability">
                        <div class="error" id="siblingDisabilityError"></div>
                    </div>
                    <div class="form-group">
                        <label for="guardianName">Guardian Name & Relationship in Lahore *</label>
                        <input type="text" class="form-control" id="guardianName" name="guardianName" required>
                        <div class="error" id="guardianNameError"></div>
                    </div>
                    <div class="form-group">
                        <label for="guardianPhone">Guardian Contact Number *</label>
                        <input type="text" class="form-control" id="guardianPhone" name="guardianPhone" required placeholder="+923123456789" maxlength="13" pattern="\+92[0-9]{10}" title="Format: +923123456789">
                        <div class="error" id="guardianPhoneError"></div>
                    </div>
                    <div class="nav-btns">
                        <button type="button" class="btn btn-secondary prev-step">Previous</button>
                        <button type="button" class="btn btn-primary next-step">Next</button>
                    </div>
                </div>

                <!-- Step 3: Medical History -->
                <div class="step" data-step="3">
                    <h4>Step 3: Medical History</h4>
                    <div class="form-group">
                        <label for="disabilityCertificate">Disability Certificate (Optional)</label>
                        <input type="file" class="form-control-file" id="disabilityCertificate" name="disabilityCertificate" accept=".pdf,.doc,.docx,.png,.jpg,.jpeg">
                        <div class="error" id="disabilityCertificateError"></div>
                    </div>
                    <div class="form-group">
                        <label for="disabilityName">Name of Disability *</label>
                        <select class="form-control" id="disabilityName" name="disabilityName" required>
                            <option value="">Select Disability</option>
                            <option value="Intellectual Disability">Intellectual Disability</option>
                            <option value="Visual Impairment">Visual Impairment</option>
                            <option value="Hearing Impairment">Hearing Impairment</option>
                            <option value="Physical Disability">Physical Disability</option>
                        </select>
                        <div class="error" id="disabilityNameError"></div>
                    </div>
                    <div class="form-group">
                        <label for="medicalHistory">Brief Medical History</label>
                        <textarea class="form-control" id="medicalHistory" name="medicalHistory" rows="3"></textarea>
                        <div class="error" id="medicalHistoryError"></div>
                    </div>
                    <div class="form-group">
                        <label for="regularMedication">Any Medication Used Regularly</label>
                        <textarea class="form-control" id="regularMedication" name="regularMedication" rows="2"></textarea>
                        <div class="error" id="regularMedicationError"></div>
                    </div>
                    <div class="form-group">
                        <label for="assistiveDevice">Any Assistive Device Used</label>
                        <input type="text" class="form-control" id="assistiveDevice" name="assistiveDevice">
                        <div class="error" id="assistiveDeviceError"></div>
                    </div>
                    <div class="form-group">
                        <label for="epilepsy">Epilepsy</label>
                        <select class="form-control" id="epilepsy" name="epilepsy">
                            <option value="">Select</option>
                            <option value="Yes">Yes</option>
                            <option value="No">No</option>
                        </select>
                        <div class="error" id="epilepsyError"></div>
                    </div>
                    <div class="form-group">
                        <label for="drugAddiction">Drug Addiction/Smoking</label>
                        <select class="form-control" id="drugAddiction" name="drugAddiction">
                            <option value="">Select</option>
                            <option value="Yes">Yes</option>
                            <option value="No">No</option>
                        </select>
                        <div class="error" id="drugAddictionError"></div>
                    </div>
                    <div class="form-group">
                        <label for="assistant">Accompanied by Assistant</label>
                        <select class="form-control" id="assistant" name="assistant">
                            <option value="">Select</option>
                            <option value="Yes">Yes</option>
                            <option value="No">No</option>
                        </select>
                        <div class="error" id="assistantError"></div>
                    </div>
                    <div class="form-group">
                        <label for="communicableDisease">Detail of Communicable Disease</label>
                        <textarea class="form-control" id="communicableDisease" name="communicableDisease" rows="2"></textarea>
                        <div class="error" id="communicableDiseaseError"></div>
                    </div>
                    <div class="nav-btns">
                        <button type="button" class="btn btn-secondary prev-step">Previous</button>
                        <button type="button" class="btn btn-primary next-step">Next</button>
                    </div>
                </div>

                <!-- Step 4: Education & Preferences -->
                <div class="step" data-step="4">
                    <h4>Step 4: Education & Preferences</h4>
                    <div class="form-group">
                        <label for="educationLevel">Education Level *</label>
                        <select class="form-control" id="educationLevel" name="educationLevel" required>
                            <option value="">Select Education Level</option>
                            <option value="Primary">Primary</option>
                            <option value="Middle">Middle</option>
                            <option value="Matric">Matric</option>
                            <option value="Intermediate">Intermediate</option>
                            <option value="Graduation">Graduation</option>
                            <option value="Masters">Masters</option>
                            <option value="No Education">No Education</option>
                        </select>
                        <div class="error" id="educationLevelError"></div>
                    </div>
                    <div class="form-group">
                        <label for="documents">Degree Certificate/Credentials (PDF/DOC/DOCX/PNG/JPG/JPEG) *</label>
                        <input type="file" class="form-control-file" id="documents" name="documents" accept=".pdf,.doc,.docx,.png,.jpg,.jpeg" required multiple>
                        <div class="error" id="documentsError"></div>
                    </div>
                    <div class="form-group">
                        <label for="course">Course Taken *</label>
                        <select class="form-control" id="course" name="course" required>
                            <option value="">Select Course</option>
                            <option value="Arts and Crafts">Arts and Crafts</option>
                            <option value="General Electrician">General Electrician</option>
                            <option value="Beautician">Beautician</option>
                            <option value="Cooking and Baking">Cooking and Baking</option>
                            <option value="Computer Hardware and Mobile Repairing">Computer Hardware and Mobile Repairing</option>
                            <option value="Computer Software">Computer Software</option>
                            <option value="Domestic Tailoring">Domestic Tailoring</option>
                            <option value="Call Center + Telephone Operator">Call Center + Telephone Operator</option>
                        </select>
                        <div class="error" id="courseError"></div>
                    </div>
                    <div class="form-group">
                        <label for="admissionType">Admission Type *</label>
                        <select class="form-control" id="admissionType" name="admissionType" required>
                            <option value="">Select Admission Type</option>
                            <option value="Day Scholar">Day Scholar</option>
                            <option value="Hostel Boarder">Hostel Boarder</option>
                        </select>
                        <div class="error" id="admissionTypeError"></div>
                    </div>
                    <div class="form-group">
                        <label for="durationStay">Duration of Stay (Months, Optional)</label>
                        <input type="number" class="form-control" id="durationStay" name="durationStay" min="1" step="1">
                        <div class="error" id="durationStayError"></div>
                    </div>
                    <div class="form-group">
                        <label for="pickDrop">Responsibility of Pick & Drop (Name & Contact Number from Family)</label>
                        <input type="text" class="form-control" id="pickDrop" name="pickDrop">
                        <div class="error" id="pickDropError"></div>
                    </div>
                    <div class="form-group">
                        <label for="affidavit">Attached Student Affidavit with Form *</label>
                        <select class="form-control" id="affidavit" name="affidavit" required>
                            <option value="">Select</option>
                            <option value="Yes">Yes</option>
                            <option value="No">No</option>
                        </select>
                        <div class="error" id="affidavitError"></div>
                    </div>
                    <div class="form-group">
                        <label for="admissionDate">Date of Admission *</label>
                        <input type="date" class="form-control" id="admissionDate" name="admissionDate" required value="{{ today }}" max="{{ today }}">
                        <div class="error" id="admissionDateError"></div>
                    </div>
                    <div class="nav-btns">
                        <button type="button" class="btn btn-secondary prev-step">Previous</button>
                        <button type="button" class="btn btn-primary next-step">Next</button>
                    </div>
                </div>

                <!-- Step 5: Affidavit -->
                <div class="step" data-step="5" style="display: none;">
                    <h4>Step 5: Student Affidavit</h4>
                    <div class="affidavit-section">
                        <p>I <span id="affidavitName" contenteditable="true" class="form-control" style="display: inline; width: 200px;"></span> residing at <span id="affidavitAddress" contenteditable="true" class="form-control" style="display: inline; width: 300px;"></span> solemnly affirm and declare as follows:</p>
                        <ol>
                            <li>I am a student currently enrolled at Nasheman for course <span id="affidavitCourse" class="form-control" style="display: inline; width: 200px;" readonly></span>.</li>
                            <li>I have never been involved in any criminal activities.</li>
                            <li>I do not have any police record.</li>
                            <li>I understand that any involvement in criminal activities or discovery of a police record during my enrollment may result in legal action against me. Additionally, I acknowledge that the institution reserves the right to cancel my admission in such circumstances.</li>
                            <li>I understand the importance of maintaining a clean record and commit to continue abiding by the law.</li>
                            <li>I affirm that the information provided in this affidavit is true and correct to the best of my knowledge.</li>
                        </ol>
                        <div class="form-group">
                            <label for="affidavitDate">Date *</label>
                            <input type="date" class="form-control" id="affidavitDate" name="affidavitDate" required value="{{ today }}" max="{{ today }}">
                            <div class="error" id="affidavitDateError"></div>
                        </div>
                        <div class="form-group">
                            <label><input type="checkbox" id="affidavitAgreement" name="affidavitAgreement" required> I agree to the terms of the affidavit</label>
                            <div class="error" id="affidavitAgreementError"></div>
                        </div>
                    </div>
                    <div class="nav-btns">
                        <button type="button" class="btn btn-secondary prev-step">Previous</button>
                        <button type="button" class="btn btn-primary next-step">Next</button>
                    </div>
                </div>

                <!-- Step 6: Summary/Review -->
                <div class="step" data-step="6">
                    <div class="review-container">
                        <div class="review-header">
                            <h1>Skill Development Center for Persons with Disabilities, Lahore</h1>
                            <h2>Application Summary</h2>
                        </div>
                        <div class="review-photo" id="reviewPhotoContainer">
                            <img id="reviewPhoto" src="" alt="Student Photo">
                        </div>
                        <div class="review-section">
                            <h5>Personal Information</h5>
                            <table class="review-table">
                                <tr><th>Student Name</th><td><span id="reviewStudentName"></span></td></tr>
                                <tr><th>Gender</th><td><span id="reviewGender"></span></td></tr>
                                <tr><th>Age</th><td><span id="reviewAge"></span></td></tr>
                                <tr><th>Phone #</th><td><span id="reviewPhone"></span></td></tr>
                                <tr><th>Date of Birth</th><td><span id="reviewDob"></span></td></tr>
                                <tr><th>Address</th><td><span id="reviewAddress"></span></td></tr>
                                <tr><th>Student CNIC</th><td><span id="reviewCnic"></span></td></tr>
                                <tr><th>Student Occupation</th><td><span id="reviewStudentOccupation"></span></td></tr>
                            </table>
                        </div>
                        <div class="review-section">
                            <h5>Guardian Information</h5>
                            <table class="review-table">
                                <tr><th>Father/Mother Name</th><td><span id="reviewParentName"></span></td></tr>
                                <tr><th>CNIC Number</th><td><span id="reviewParentCnic"></span></td></tr>
                                <tr><th>Contact Number</th><td><span id="reviewParentPhone"></span></td></tr>
                                <tr><th>Occupation</th><td><span id="reviewParentOccupation"></span></td></tr>
                                <tr><th>Number of Siblings</th><td><span id="reviewNumSiblings"></span></td></tr>
                                <tr><th>Disability in Siblings</th><td><span id="reviewSiblingDisability"></span></td></tr>
                                <tr><th>Guardian Name & Relationship</th><td><span id="reviewGuardianName"></span></td></tr>
                                <tr><th>Guardian Contact Number</th><td><span id="reviewGuardianPhone"></span></td></tr>
                            </table>
                        </div>
                        <div class="review-section">
                            <h5>Medical History</h5>
                            <table class="review-table">
                                <tr><th>Disability Certificate</th><td><span id="reviewDisabilityCertificate"></span></td></tr>
                                <tr><th>Name of Disability</th><td><span id="reviewDisabilityName"></span></td></tr>
                                <tr><th>Brief Medical History</th><td><span id="reviewMedicalHistory"></span></td></tr>
                                <tr><th>Regular Medication</th><td><span id="reviewRegularMedication"></span></td></tr>
                                <tr><th>Assistive Device</th><td><span id="reviewAssistiveDevice"></span></td></tr>
                                <tr><th>Epilepsy</th><td><span id="reviewEpilepsy"></span></td></tr>
                                <tr><th>Drug Addiction/Smoking</th><td><span id="reviewDrugAddiction"></span></td></tr>
                                <tr><th>Accompanied by Assistant</th><td><span id="reviewAssistant"></span></td></tr>
                                <tr><th>Communicable Disease</th><td><span id="reviewCommunicableDisease"></span></td></tr>
                            </table>
                        </div>
                        <div class="review-section">
                            <h5>Education & Preferences</h5>
                            <table class="review-table">
                                <tr><th>Education Level</th><td><span id="reviewEducationLevel"></span></td></tr>
                                <tr><th>Degree Certificate</th><td><span id="reviewDocuments"></span></td></tr>
                                <tr><th>Course Taken</th><td><span id="reviewCourse"></span></td></tr>
                                <tr><th>Admission Type</th><td><span id="reviewAdmissionType"></span></td></tr>
                                <tr><th>Duration of Stay</th><td><span id="reviewDurationStay"></span></td></tr>
                                <tr><th>Pick & Drop Responsibility</th><td><span id="reviewPickDrop"></span></td></tr>
                                <tr><th>Attached Affidavit</th><td><span id="reviewAffidavit"></span></td></tr>
                                <tr><th>Date of Admission</th><td><span id="reviewAdmissionDate"></span></td></tr>
                            </table>
                        </div>
                        <div class="affidavit-section" id="reviewAffidavitSection" style="display: none;">
                            <h4>Student Affidavit Agreement</h4>
                            <p>I <span id="reviewAffidavitName"></span> residing at <span id="reviewAffidavitAddress"></span> solemnly affirm and declare as follows:</p>
                            <ol>
                                <li>I am a student currently enrolled at Nasheman for course <span id="reviewAffidavitCourse"></span>.</li>
                                <li>I have never been involved in any criminal activities.</li>
                                <li>I do not have any police record.</li>
                                <li>I understand that any involvement in criminal activities or discovery of a police record during my enrollment may result in legal action against me. Additionally, I acknowledge that the institution reserves the right to cancel my admission in such circumstances.</li>
                                <li>I understand the importance of maintaining a clean record and commit to continue abiding by the law.</li>
                                <li>I affirm that the information provided in this affidavit is true and correct to the best of my knowledge.</li>
                            </ol>
                            <p>Date: <span id="reviewAffidavitDate"></span></p>
                        </div>
                        <div class="nav-btns">
                            <button type="button" class="btn btn-secondary prev-step">Previous</button>
                            <button type="submit" class="btn btn-success" id="submitApplication">Submit Application</button>
                        </div>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- Footer -->
    <footer id="footer">
        <div class="footer_top">
            <div class="container">
                <div class="row">
                    <div class="col-lg-3 col-md-6 footer_contact">
                        <h3>Nasheman</h3>
                        <p>Social Welfare Complex, Sector D-1, Near Umar Chowk, Township, Lahore, Pakistan<br/>
                            <strong>Phone:</strong> +92 331 481 0627<br/>
                            <strong>Email:</strong> info@nasheman.org
                        </p>
                    </div>
                    <div class="col-lg-2 col-md-6 footer_links">
                        <h4>Useful Links</h4>
                        <ul>
                            <li><i class="fa fa-chevron-right"></i><a href="{{ url_for('index') }}">Home</a></li>
                            <li><i class="fa fa-chevron-right"></i><a href="{{ url_for('about') }}">About</a></li>
                            <li><i class="fa fa-chevron-right"></i><a href="{{ url_for('courses') }}">Courses</a></li>
                            <li><i class="fa fa-chevron-right"></i><a href="{{ url_for('events') }}">Events</a></li>
                            <li><i class="fa fa-chevron-right"></i><a href="{{ url_for('programs') }}">Programs</a></li>
                            <li><i class="fa fa-chevron-right"></i><a href="{{ url_for('admissions') }}">Admissions</a></li>
                            <li><i class="fa fa-chevron-right"></i><a href="{{ url_for('facilities') }}">Facilities</a></li>
                            <li><i class="fa fa-chevron-right"></i><a href="{{ url_for('contact') }}">Contact</a></li>
                        </ul>
                    </div>
                    <div class="col-lg-3 col-md-6 footer_links">
                        <h4>Our Programs</h4>
                        <ul>
                            <li><i class="fa fa-chevron-right"></i><a href="#">Sensory Learning</a></li>
                            <li><i class="fa fa-chevron-right"></i><a href="#">Communication Skills</a></li>
                            <li><i class="fa fa-chevron-right"></i><a href="#">Life Skills</a></li>
                            <li><i class="fa fa-chevron-right"></i><a href="#">Therapy Programs</a></li>
                        </ul>
                    </div>
                    <div class="col-lg-4 col-md-6 footer_newsletter">
                        <h4>Join Our Newsletter</h4>
                        <p>Stay updated with our latest events, courses, and success stories!</p>
                        <form>
                            <input name="email" type="email" placeholder="Enter email" />
                            <input type="submit" value="Subscribe" />
                        </form>
                    </div>
                </div>
            </div>
        </div>
        <div class="container d-md-flex py-4">
            <div class="mr-md-auto text-center text-md-left">
                <div class="copyright">
                    <p class="mb-0">©Copyright Nasheman. All Rights Reserved</p>
                </div>
                <div class="credits">
                    Designed by <a href="#">Software Engineers</a>
                </div>
            </div>
            <div class="social pt-3 pt-md-0 d-flex flex-row align-items-center">
                <a href="#"><i class="fa fa-facebook"></i></a>
                <a href="#"><i class="fa fa-twitter"></i></a>
                <a href="#"><i class="fa fa-instagram"></i></a>
                <a href="#"><i class="fa fa-linkedin"></i></a>
            </div>
        </div>
    </footer>

    <!-- JS Scripts -->
    <script src="https://code.jquery.com/jquery-3.5.1.min.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/js/bootstrap.min.js" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/slick-carousel/1.8.1/slick.min.js"></script>
    <script>
    $(document).ready(function() {
        let currentStep = 1;
        let totalSteps = 5; // Default to 5 steps (no affidavit)
        const $steps = $('.step');
        const $progressBar = $('#progressBar');
        const $submitButton = $('#submitApplication');
        const $stepIcons = $('.step-icon');
        let affidavitRequired = false;
        let photoDataUrl = ''; // Store photo data URL

        // Ensure submit button exists
        if ($submitButton.length === 0) {
            console.error('Submit button (#submitApplication) not found in DOM');
            alert('Error: Submit button not found in the form. Please check the HTML.');
        } else {
            console.log('Submit button found:', $submitButton);
        }

        // Function to format CNIC
        window.formatCNIC = function(input) {
            let value = input.value.replace(/[^0-9]/g, '');
            if (value.length > 13) value = value.slice(0, 13);
            let formatted = '';
            if (value.length > 0) formatted = value.slice(0, 5);
            if (value.length > 5) formatted += '-' + value.slice(5, 12);
            if (value.length > 12) formatted += '-' + value.slice(12, 13);
            input.value = formatted;
            validateStep(currentStep);
        };

        // Function to calculate age based on DOB
        window.calculateAge = function() {
            const dob = new Date($('#dob').val());
            const today = new Date();
            if (isNaN(dob) || dob > today) {
                $('#age').val('');
                $('#ageError').text('Date of birth cannot be in the future.').addClass('show');
                return;
            }
            let age = today.getFullYear() - dob.getFullYear();
            const monthDiff = today.getMonth() - dob.getMonth();
            if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < dob.getDate())) {
                age--;
            }
            $('#age').val(age >= 1 && age <= 120 ? age : '');
            validateStep(1);
        };

        // Photo preview and update
        $('#photo').on('change', function() {
            const file = this.files[0];
            const $preview = $('#photoPreview');
            const $error = $('#photoError');
            photoDataUrl = ''; // Reset photo data URL
            if (file) {
                const maxSize = 5 * 1024 * 1024;
                const allowedTypes = ['image/png', 'image/jpeg', 'image/jpg'];
                if (!allowedTypes.includes(file.type)) {
                    $error.text('Invalid file type. Only PNG, JPG, JPEG allowed.').addClass('show');
                    $preview.hide().attr('src', '');
                    this.value = '';
                    $('#reviewPhotoContainer').addClass('no-photo');
                    $('#reviewPhoto').attr('src', '').hide();
                    console.log('Photo validation failed: Invalid file type');
                    return;
                }
                if (file.size > maxSize) {
                    $error.text('File size exceeds 5MB.').addClass('show');
                    $preview.hide().attr('src', '');
                    this.value = '';
                    $('#reviewPhotoContainer').addClass('no-photo');
                    $('#reviewPhoto').attr('src', '').hide();
                    console.log('Photo validation failed: File size exceeds 5MB');
                    return;
                }
                const reader = new FileReader();
                reader.onload = function(e) {
                    photoDataUrl = e.target.result;
                    $preview.attr('src', photoDataUrl).show();
                    $error.text('').removeClass('show');
                    $('#reviewPhoto').attr('src', photoDataUrl).show();
                    $('#reviewPhotoContainer').removeClass('no-photo');
                    console.log('Photo preview set successfully:', photoDataUrl.substring(0, 50) + '...');
                    if (currentStep === 6) updateSummary();
                };
                reader.onerror = function() {
                    $error.text('Error reading photo file.').addClass('show');
                    $preview.hide().attr('src', '');
                    $('#reviewPhotoContainer').addClass('no-photo');
                    $('#reviewPhoto').attr('src', '').hide();
                    console.error('FileReader error for photo');
                };
                reader.readAsDataURL(file);
            } else {
                $preview.hide().attr('src', '');
                $error.text('Please upload a photo.').addClass('show');
                $('#reviewPhotoContainer').addClass('no-photo');
                $('#reviewPhoto').attr('src', '').hide();
                console.log('No photo selected');
            }
            validateStep(1);
        });

        // Documents validation
        $('#documents').on('change', function() {
            const files = this.files;
            const $error = $('#documentsError');
            if (files.length === 0) {
                $error.text('Please upload at least one degree certificate.').addClass('show');
                validateStep(4);
                return;
            }
            const maxSize = 5 * 1024 * 1024;
            const allowedTypes = ['application/pdf', 'application/msword', 'application/vnd.openxmlformats-officedocument.wordprocessingml.document', 'image/png', 'image/jpeg', 'image/jpg'];
            for (let file of files) {
                if (!allowedTypes.includes(file.type)) {
                    $error.text('Invalid file type. Only PDF, DOC, DOCX, PNG, JPG, JPEG allowed.').addClass('show');
                    this.value = '';
                    validateStep(4);
                    return;
                }
                if (file.size > maxSize) {
                    $error.text('File size exceeds 5MB.').addClass('show');
                    this.value = '';
                    validateStep(4);
                    return;
                }
            }
            $error.text('').removeClass('show');
            validateStep(4);
        });

        // Show step function
        function showStep(step) {
            console.log('Showing step:', step, 'Affidavit required:', affidavitRequired, 'Total steps:', totalSteps);
            if (step === 5 && !affidavitRequired) {
                step = 6; // Skip Step 5 if affidavit is not required
            }
            currentStep = step;
            $steps.removeClass('active').filter(`[data-step="${step}"]`).addClass('active');
            $stepIcons.removeClass('active').filter(`[data-step="${step}"]`).addClass('active');
            const progress = ((step - 1) / 5) * 100; // Always 6 steps for progress bar
            $progressBar.css('width', `${progress}%`);
            $('.prev-step').toggle(step !== 1);
            $('.next-step').toggle(step < 6);

            // Force submit button visibility on Step 6
            if (step === 6) {
                $submitButton.addClass('show').prop('disabled', false);
                console.log('Submit button forced to show on Step 6');
            } else {
                $submitButton.removeClass('show');
            }

            if (step === 5 || step === 6) {
                updateSummary();
            }
            validateStep(step);
            console.log('Submit button state:', $submitButton.is(':visible') ? 'Visible' : 'Hidden', 'Disabled:', $submitButton.prop('disabled'));
        }

        // Update summary
        function updateSummary() {
            console.log('Updating summary for step', currentStep);
            $('#reviewStudentName').text($('#studentName').val() || 'Not provided');
            $('#reviewGender').text($('#gender').val() === 'M' ? 'Male' : $('#gender').val() === 'F' ? 'Female' : 'Not provided');
            $('#reviewAge').text($('#age').val() || 'Not provided');
            $('#reviewPhone').text($('#phone').val() || 'Not provided');
            $('#reviewDob').text($('#dob').val() || 'Not provided');
            $('#reviewAddress').text($('#address').val() || 'Not provided');
            $('#reviewCnic').text($('#cnic').val() || 'Not provided');
            $('#reviewStudentOccupation').text($('#studentOccupation').val() || 'Not provided');
            $('#reviewParentName').text($('#parentName').val() || 'Not provided');
            $('#reviewParentCnic').text($('#parentCnic').val() || 'Not provided');
            $('#reviewParentPhone').text($('#parentPhone').val() || 'Not provided');
            $('#reviewParentOccupation').text($('#parentOccupation').val() || 'Not provided');
            $('#reviewNumSiblings').text($('#numSiblings').val() || 'Not provided');
            $('#reviewSiblingDisability').text($('#siblingDisability').val() || 'None');
            $('#reviewGuardianName').text($('#guardianName').val() || 'Not provided');
            $('#reviewGuardianPhone').text($('#guardianPhone').val() || 'Not provided');
            $('#reviewDisabilityCertificate').text($('#disabilityCertificate')[0].files[0] ? $('#disabilityCertificate')[0].files[0].name : 'Not provided');
            $('#reviewDisabilityName').text($('#disabilityName').val() || 'Not provided');
            $('#reviewMedicalHistory').text($('#medicalHistory').val() || 'None');
            $('#reviewRegularMedication').text($('#regularMedication').val() || 'None');
            $('#reviewAssistiveDevice').text($('#assistiveDevice').val() || 'None');
            $('#reviewEpilepsy').text($('#epilepsy').val() || 'Not provided');
            $('#reviewDrugAddiction').text($('#drugAddiction').val() || 'Not provided');
            $('#reviewAssistant').text($('#assistant').val() || 'Not provided');
            $('#reviewCommunicableDisease').text($('#communicableDisease').val() || 'None');
            $('#reviewEducationLevel').text($('#educationLevel').val() || 'Not provided');
            $('#reviewDocuments').text($('#documents')[0].files[0] ? Array.from($('#documents')[0].files).map(file => file.name).join(', ') : 'Not provided');
            $('#reviewCourse').text($('#course').val() || 'Not provided');
            $('#reviewAdmissionType').text($('#admissionType').val() || 'Not provided');
            $('#reviewDurationStay').text($('#durationStay').val() ? `${$('#durationStay').val()} months` : 'None');
            $('#reviewPickDrop').text($('#pickDrop').val() || 'None');
            $('#reviewAffidavit').text($('#affidavit').val() || 'Not provided');
            $('#reviewAdmissionDate').text($('#admissionDate').val() || 'Not provided');

            // Photo in summary
            if (photoDataUrl) {
                $('#reviewPhoto').attr('src', photoDataUrl).show();
                $('#reviewPhotoContainer').removeClass('no-photo');
                console.log('Summary photo set from cached data:', photoDataUrl.substring(0, 50) + '...');
            } else {
                $('#reviewPhoto').attr('src', '').hide();
                $('#reviewPhotoContainer').addClass('no-photo');
                console.log('No photo available for summary');
            }

            // Affidavit section
            if (affidavitRequired) {
                $('#reviewAffidavitSection').show();
                $('#affidavitName').text($('#studentName').val() || 'Not provided');
                $('#affidavitAddress').text($('#address').val() || 'Not provided');
                $('#affidavitCourse').text($('#course').val() || 'Not provided');
                $('#reviewAffidavitName').text($('#affidavitName').text());
                $('#reviewAffidavitAddress').text($('#affidavitAddress').text());
                $('#reviewAffidavitCourse').text($('#affidavitCourse').text());
                $('#reviewAffidavitDate').text($('#affidavitDate').val() || 'Not provided');
            } else {
                $('#reviewAffidavitSection').hide();
            }
        }

        // Handle affidavit toggle
        $('#affidavit').on('change', function() {
            affidavitRequired = $(this).val() === 'Yes';
            console.log('Affidavit changed to:', $(this).val(), 'Affidavit required:', affidavitRequired);
            if (affidavitRequired) {
                $('.step-icon[data-step="5"]').show();
                $steps.filter('[data-step="5"]').css('display', '');
                totalSteps = 6;
            } else {
                $('.step-icon[data-step="5"]').hide();
                $steps.filter('[data-step="5"]').hide();
                totalSteps = 5;
            }
            if (currentStep === 6) updateSummary();
            validateStep(currentStep);
        }).trigger('change');

        // Validate step
        function validateStep(step) {
            let isValid = true;
            console.log('Validating step:', step);

            if (step === 5 && !affidavitRequired) {
                return true; // Skip validation for Step 5 if affidavit not required
            }

            $(`.step[data-step="${step}"] .form-control[required], .step[data-step="${step}"] .form-control-file[required]`).each(function() {
                const $input = $(this);
                const $error = $(`#${$input.attr('id')}Error`);

                if ($input.attr('id') === 'affidavitAgreement' && !affidavitRequired) {
                    $error.text('').removeClass('show');
                    return true;
                }

                if ($input.attr('type') === 'file' && $input.attr('id') === 'photo' && step === 1) {
                    if ($input[0].files.length === 0) {
                        isValid = false;
                        $error.text('Please upload a photo.').addClass('show');
                    } else {
                        const maxSize = 5 * 1024 * 1024;
                        const allowedTypes = ['image/png', 'image/jpeg', 'image/jpg'];
                        const file = $input[0].files[0];
                        if (!allowedTypes.includes(file.type)) {
                            isValid = false;
                            $error.text('Invalid file type. Only PNG, JPG, JPEG allowed.').addClass('show');
                        } else if (file.size > maxSize) {
                            isValid = false;
                            $error.text('File size exceeds 5MB.').addClass('show');
                        } else {
                            $error.text('').removeClass('show');
                        }
                    }
                } else if ($input.attr('type') === 'file' && $input.attr('id') === 'documents' && step === 4) {
                    if ($input[0].files.length === 0) {
                        isValid = false;
                        $error.text('Please upload at least one degree certificate.').addClass('show');
                    } else {
                        const maxSize = 5 * 1024 * 1024;
                        const allowedTypes = ['application/pdf', 'application/msword', 'application/vnd.openxmlformats-officedocument.wordprocessingml.document', 'image/png', 'image/jpeg', 'image/jpg'];
                        for (let file of $input[0].files) {
                            if (!allowedTypes.includes(file.type)) {
                                isValid = false;
                                $error.text('Invalid file type. Only PDF, DOC, DOCX, PNG, JPG, JPEG allowed.').addClass('show');
                                return;
                            }
                            if (file.size > maxSize) {
                                isValid = false;
                                $error.text('File size exceeds 5MB.').addClass('show');
                                return;
                            }
                        }
                        $error.text('').removeClass('show');
                    }
                } else if (!$input.val().trim() && $input.attr('required')) {
                    isValid = false;
                    $error.text('This field is required.').addClass('show');
                } else if ($input.attr('id') === 'cnic' && !/^\d{5}-\d{7}-\d{1}$/.test($input.val()) && step === 1) {
                    isValid = false;
                    $error.text('CNIC must be in the format 12345-1234567-1.').addClass('show');
                } else if ($input.attr('id') === 'parentCnic' && !/^\d{5}-\d{7}-\d{1}$/.test($input.val()) && step === 2) {
                    isValid = false;
                    $error.text('CNIC must be in the format 12345-1234567-1.').addClass('show');
                } else if (($input.attr('id') === 'phone' || $input.attr('id') === 'parentPhone' || $input.attr('id') === 'guardianPhone') && !/^\+92[0-9]{10}$/.test($input.val())) {
                    isValid = false;
                    $error.text('Phone must be in the format +923123456789.').addClass('show');
                } else if ($input.attr('id') === 'age' && ($input.val() < 1 || $input.val() > 120) && step === 1) {
                    isValid = false;
                    $error.text('Age must be between 1 and 120.').addClass('show');
                } else if ($input.attr('type') === 'date' && $input.attr('max') && new Date($input.val()) > new Date($input.attr('max'))) {
                    isValid = false;
                    $error.text('Date cannot be in the future.').addClass('show');
                } else if ($input.attr('id') === 'affidavitAgreement' && $input.attr('required') && !$input.is(':checked') && step === 5) {
                    isValid = false;
                    $error.text('You must agree to the affidavit terms.').addClass('show');
                } else {
                    $error.text('').removeClass('show');
                }
            });

            console.log('Validation result for step', step, ':', isValid);
            $('.next-step').prop('disabled', !isValid);
            if (step === 6) {
                const requiredSteps = affidavitRequired ? [1, 2, 3, 4, 5] : [1, 2, 3, 4];
                let allStepsValid = true;
                requiredSteps.forEach(s => {
                    if (!validateStep(s)) {
                        allStepsValid = false;
                    }
                });
                $submitButton.prop('disabled', !allStepsValid);
                console.log('Submit button state:', $submitButton.is(':visible') ? 'Visible' : 'Hidden', 'Disabled:', $submitButton.prop('disabled'));
            }
            return isValid;
        }

        // Next step
        $('.next-step').click(function() {
            if (validateStep(currentStep)) {
                if (currentStep === 4 && !affidavitRequired) {
                    currentStep = 6;
                } else {
                    currentStep++;
                }
                if (currentStep > 6) currentStep = 6;
                console.log('Moving to step:', currentStep);
                showStep(currentStep);
            } else {
                console.log('Validation failed on step:', currentStep);
                alert('Please fill all required fields correctly.');
            }
        });

        // Previous step
        $('.prev-step').click(function() {
            if (currentStep === 6 && !affidavitRequired) {
                currentStep = 4;
            } else {
                currentStep--;
            }
            if (currentStep < 1) currentStep = 1;
            console.log('Moving to step:', currentStep);
            showStep(currentStep);
        });

        // Form submission
        $('#applicationForm').on('submit', function(e) {
            e.preventDefault();
            console.log('Form submit event triggered, currentStep:', currentStep);
            if (currentStep !== 6) {
                alert('Please review your application on the final step before submitting.');
                currentStep = 6;
                showStep(currentStep);
                return;
            }
            const requiredSteps = affidavitRequired ? [1, 2, 3, 4, 5] : [1, 2, 3, 4];
            let isFormValid = true;
            requiredSteps.forEach(step => {
                if (!validateStep(step)) {
                    isFormValid = false;
                }
            });
            console.log('Form validation result:', isFormValid);
            if (isFormValid) {
                console.log('Submitting form via AJAX');
                $submitButton.prop('disabled', true).text('Submitting...');
                const formData = new FormData(this);
                $.ajax({
                    url: $(this).attr('action'),
                    type: 'POST',
                    data: formData,
                    processData: false,
                    contentType: false,
                    success: function(response) {
                        console.log('AJAX success:', response);
                        alert('Application submitted successfully!');
                        window.location.href = response.redirect || "{{ url_for('apply_now') }}";
                    },
                    error: function(xhr, status, error) {
                        console.error('AJAX error:', status, error, xhr.responseText);
                        let errorMessage = 'Error submitting application. Please try again.';
                        try {
                            const response = JSON.parse(xhr.responseText);
                            if (response.error) errorMessage = response.error;
                        } catch (e) {
                            const match = xhr.responseText.match(/<div class="alert alert-error alert-dismissible fade show" role="alert">(.+?)<button/);
                            if (match && match[1]) errorMessage = match[1].trim();
                        }
                        alert(errorMessage);
                        $submitButton.prop('disabled', false).text('Submit Application');
                    }
                });
            } else {
                alert('Please complete all required fields correctly.');
                for (let step of requiredSteps) {
                    if (!validateStep(step)) {
                        currentStep = step;
                        showStep(currentStep);
                        break;
                    }
                }
            }
        });

        // Quote rotation
        const quotes = [
            "Join Nasheman to unlock your potential!",
            "Empowering lives through skill development!",
            "Your journey to independence starts here!",
            "Admissions open for a brighter future!",
            "Together, we build opportunities for all!"
        ];
        let quoteIndex = 0;
        const quoteElement = document.getElementById('quote');
        if (quoteElement) {
            function rotateQuote() {
                quoteElement.style.opacity = '0';
                setTimeout(() => {
                    quoteElement.textContent = quotes[quoteIndex];
                    quoteElement.classList.add('fade');
                    quoteElement.style.opacity = '1';
                    setTimeout(() => {
                        quoteElement.classList.remove('fade');
                    }, 500);
                    quoteIndex = (quoteIndex + 1) % quotes.length;
                }, 500);
            }
            rotateQuote();
            setInterval(rotateQuote, 2500);
        }

        // Close flash messages
        document.querySelectorAll('.alert .close').forEach(closeBtn => {
            closeBtn.addEventListener('click', () => {
                closeBtn.parentElement.style.display = 'none';
            });
        });

        // Phone number formatting
        $('#phone, #parentPhone, #guardianPhone').on('input', function() {
            let value = $(this).val().replace(/[^0-9+]/g, '');
            if (!value.startsWith('+92')) {
                value = '+92' + value.replace(/^\+92/, '');
            }
            let digits = value.replace('+92', '').slice(0, 10);
            $(this).val('+92' + digits);
            validateStep(currentStep);
        }).on('focus', function() {
            if (!$(this).val()) $(this).val('+92');
        }).on('blur', function() {
            if ($(this).val() === '+92') $(this).val('');
        }).on('keypress', function(e) {
            const charCode = e.which ? e.which : e.keyCode;
            if (charCode !== 8 && (charCode < 48 || charCode > 57)) {
                e.preventDefault();
            }
            let currentValue = $(this).val().replace('+92', '');
            if (currentValue.length >= 10 && charCode !== 8) {
                e.preventDefault();
            }
        });

        // CNIC input restrictions
        $('#cnic, #parentCnic').on('keypress', function(e) {
            const charCode = e.which ? e.which : e.keyCode;
            if (charCode !== 8 && (charCode < 48 || charCode > 57)) {
                e.preventDefault();
            }
            if ($(this).val().length >= 15 && charCode !== 8) {
                e.preventDefault();
            }
        });

        // Input change event
        $('.form-control[required], .form-control-file[required]').on('input change', function() {
            validateStep(currentStep);
            if (currentStep === 6) updateSummary();
        });

        // Initial display
        showStep(currentStep);
        validateStep(currentStep);
    });
    </script>
</body>
</html>